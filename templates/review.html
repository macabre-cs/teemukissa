<!DOCTYPE html>
<html>
  <head>
    <title>{{ review.variety.capitalize() }} arvostelu</title>
    <link rel="stylesheet" href="/static/main.css" />
  </head>
  <body>
    <header class="header">
      <h1>{{ review.variety.capitalize() }} arvostelu</h1>
    </header>

    <nav class="nav">
      <a href="/teatimes">Teehetket</a> | <a href="/add_review">Lisää teehetki</a> | <a href="/search">Haku</a> |
      <a href="/">Etusivu</a> | {% if session.user_id %} <a href="/logout">Kirjaudu ulos</a> |
      <a href="/user/{{ session.user_id }}">Oma profiili</a>
      {% else %}
      <a href="/login">Kirjaudu sisään</a>
      {% endif %}
    </nav>

    {% for message in get_flashed_messages() %}
    <div class="message">{{ message }}</div>
    {% endfor %}

    <section class="review">
      <h2>{{ review.title | show_lines }}</h2>

      <p>
        <strong><a href="/user/{{ review.user_id }}">{{ review.username }}</a>:</strong>
        {{ review.content | show_lines }}
        <em>({{ review.sent_at }})</em>
      </p>

      {% if review.rating %}
      <p>Tassuarvosana: {{ review.rating }}</p>
      {% endif %}

      <div class="actions">
        {% if review.user_id == session['user_id'] %}
        <a href="/edit/{{ review.id }}">Muokkaa</a> |
        <a href="/remove/{{ review.id }}">Poista</a>
        {% endif %}
      </div>
    </section>

    {% if comments %}
    <section class="comments">
      <h3>Kommentit</h3>
      <ul>
        {% for comment in comments %}
        <li class="comment">
          <strong><a href="/user/{{ comment.user_id }}">{{ comment.username }}</a>:</strong>
          <span id="comment-{{ comment.id }}">{{ comment.content | show_lines }}</span>
          <em>({{ comment.sent_at }})</em>

          {% if comment.user_id == session['user_id'] %}
          <input type="checkbox" id="edit-toggle-{{ comment.id }}" class="edit-toggle" hidden />

          <div class="comment-actions">
            <label for="edit-toggle-{{ comment.id }}" class="text-button">Muokkaa</label>
            <form action="/delete_comment" method="POST" class="inline-form">
              <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
              <input type="hidden" name="comment_id" value="{{ comment.id }}" />
              <input type="hidden" name="review_id" value="{{ review.id }}" />
              <button type="submit" class="text-button">Poista</button>
            </form>
          </div>

          <form action="/edit_comment" method="POST" class="edit-form">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
            <input type="hidden" name="comment_id" value="{{ comment.id }}" />
            <input type="hidden" name="review_id" value="{{ review.id }}" />
            <textarea name="content" rows="2" required>{{ comment.content }}</textarea>
            <div class="edit-actions">
              <button type="submit" class="text-button">Tallenna</button>
              <label for="edit-toggle-{{ comment.id }}" class="cancel-button">Peruuta</label>
            </div>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      <p>
        {% if page > 1 %}
        <a href="/review/{{ review.id }}/{{ page - 1 }}">&lt;&lt; Edellinen</a>
        {% endif %} Sivu {{ page }}/{{ page_count }} {% if page < page_count %}
        <a href="/review/{{ review.id }}/{{ page + 1 }}">Seuraava &gt;&gt;</a>
        {% endif %}
      </p>
    </section>
    {% endif %}

    {% if session.user_id %}
    <section class="create-review">
      <h4>Lisää kommentti</h4>
      <form action="/add_comment" method="POST">
        <input type="hidden" name="review_id" value="{{ review.id }}" />
        <input type="hidden" name="source" value="review" />
        <textarea
          name="content"
          rows="2"
          maxlength="1000"
          required
          placeholder="Kirjoita kommenttisi tähän..."
        ></textarea>
        <br />
        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}" />
        <input type="submit" value="Lisää kommentti" />
      </form>
    </section>
    {% endif %}

    <div class="buttons">
      <a href="/tea/{{ review.variety }}">Takaisin {{ review.variety }} arvosteluihin</a>
    </div>
  </body>
</html>
